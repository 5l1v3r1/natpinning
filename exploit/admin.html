<html>
	<head>
		<title>Gremwell NAT Pinning test suite</title>
		<META HTTP-EQUIV="Pragma" CONTENT="no-cache">
		<META HTTP-EQUIV="Expires" CONTENT="-1">
	</head>
	<body onload="">
	 <script type="text/javascript" src="tools.js"></script>
	 <script type="text/javascript" src="admin.js"></script>
	<link rel="STYLESHEET" type="text/css" media="screen" href="admin.css" />
	 <script type="text/javascript">
			function loadSWF(){
				try{
					//where dragons be
  					var html,parentObj;
					parentObj = document.getElementById("SWFContainer")
					if (window.ActiveXObject) {
						html = httpreq(gCmdURL + "?cmd=GENFLASHIE&ci="+gClientId+"&server="+getHostAndPortFromURL());
						parentObj.innerHTML = html;
	  					obj = parentObj.firstChild;
	  					parentObj.removeChild(obj);
	  					document.body.appendChild(obj);//this ugly hack brought to you by IE8
					}else{
						html = httpreq(gCmdURL + "?cmd=GENFLASH&ci="+gClientId+"&server="+getHostAndPortFromURL());
						document.getElementById("SWFContainer").innerHTML=html;
					}
					return true;
				}catch(err){
					return false;
				}
			}
			function nextStep(){
				if (gCurrStep==1){
					var strMyIp = document.getElementById("step1_myIP").value;
					document.getElementById("page_help").innerHTML="<a href='https://github.com/allodoxaphobia/natpinning/wiki/WebGui-Step2' target='_blank'>Help</a>";
					if(isValidIp4(strMyIp)){
						gMyIP=strMyIp;
						gClientId = regclient(gMyIP);
						if (gClientId!=""){
							//display step 2 page
							gCurrStep=2;
							displayStep("Step2");
							hideNextButton(document.getElementById("step_next"),true);
							//create default tests"
							for (var i = 0; i < gProtocols.length; i++){
								addTest(gProtocols[i],gMyIP,getNextPort());
							}
							if (loadSWF()){ //loading of SWF will trigger execution of tests
								//loop for test results...
								 updateBaseCheck();
							}else{
								document.getElementById("Errmsg").innerHTML="Failed to load SWF file.";
							}
						}else{
							hideNextButton(document.getElementById("step_next"),false);
							document.getElementById("Errmsg").innerHTML="Failed to retrieve client id from server.";
						}
					}else{
						document.getElementById("Errmsg").innerHTML="Invalid IP address.";
						document.getElementById("step1_myIP").focus();
					}
				}else{
					if (gCurrStep==2){
							document.getElementById("page_help").innerHTML="<a href='https://github.com/allodoxaphobia/natpinning/wiki/WebGui-Step3' target='_blank'>Help</a>";
							gCurrStep=3;
							displayStep("Step3")
							var tmpTests = gTests;
							//resetTestArray
							gTests = []
							sProtos = "";
							hideNextButton(document.getElementById("step_next"),true);
							for (var i = 0; i < tmpTests.length; i++){
								if (tmpTests[i].RESULT=="True"){//supported protocol
									if (sProtos.length>0){sProtos = sProtos+","}
									sProtos+=tmpTests[i].PROTO;
									addTest(tmpTests[i].PROTO,gMyIP,"80");
									addTest(tmpTests[i].PROTO,otherIP(gMyIP),getNextPort());
									document.getElementById("step3_results_lowport").innerHTML+= "<li id='step3_low_port_"+ tmpTests[i].PROTO+"'>"+tmpTests[i].PROTO+" ...</li>";
									document.getElementById("step3_results_otherhost").innerHTML+= "<li id='step3_other_"+ tmpTests[i].PROTO+"'>"+tmpTests[i].PROTO+" ...</li>";
								}
							}
							setTimeout(updateBaseAndOtherHostPortCheck,5000);		
					}else{
						if (gCurrStep==3){
							var ts = new Date().getTime();
							document.location="exploit.html?ci="+escape(gClientId)+"&ip="+escape(gMyIP)+"&proto="+escape(sProtos)+"&ts="+ts;
						}
					}
				}
			}
	 </script>
	 <p>
	<div id="Step1" class="MainContainer">
		<center><img src="gremwell_logo.png" class="img_logo" /></center>
		<div class="main_text">To continue, we will require the following information from you:</div>
			<br /><br />
			<div class="main_text">Your client's IP address: <input class="step_input" id="step1_myIP" value="" len="15"></div>
			<br /><br />
	</div>
	<div id="Step2" class="MainContainer_hidden">
		<div class="main_text"><br />We are now going to determine which connection tracking modules are loaded on your gateway.
		<br />
		<ul>
			<li id="li_FTP">FTP ...</li>
			<li id="li_IRC">IRC ...</li>
			<li id="li_SIP">SIP ...</li>			
			<li id="li_H225">H225 ...</li>
		</ul>
		</div>
	</div>
	<div id="Step3" class="MainContainer_hidden">
		<div class="main_text"><br />Now that we identified the supported protcols, we are going to check them for exploitation.
			<br><br>Support for reserved ports:
			<ul id="step3_results_lowport">
			</ul>
			<br>Support for forward to 3rd party:
			<ul id="step3_results_otherhost">
			</ul>
		</div>
	</div>
	<div id="ButtonFrame" class="ButtonFrame">
		<div id="Errmsg" class="errmsg"> </div>
		<center><input type=button class=step_next id=step_next onclick="nextStep();" value="Proceed"/></center>
		<br><div class="help_link" id="page_help"><a href='https://github.com/allodoxaphobia/natpinning/wiki/WebGui-Step1' target='_blank'>Help</a></div>
	</div>
	<div id="SWFContainer"></div>
	 </center>
	</body>
</html>
